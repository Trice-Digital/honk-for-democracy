---
phase: 10-audio-polish
plan: 03
type: execute
wave: 2
depends_on: [01, 02]
files_modified:
  - src/game/systems/MusicSystem.ts
  - src/game/systems/ReactiveCueSystem.ts
autonomous: true

must_haves:
  truths:
    - "MusicSystem plays a stadium-organ style procedural music loop that changes energy with confidence level"
    - "At low confidence (<30), music is minor key, sparse, slow"
    - "At mid confidence (30-80), music is steady, moderate"
    - "At high confidence (>80), music is major key, energetic, triumphant"
    - "ReactiveCueSystem triggers audio cues (organ stingers, stomp-clap, cowbell) at confidence thresholds"
    - "Cues have a cooldown to prevent spamming"
  artifacts:
    - path: "src/game/systems/MusicSystem.ts"
      provides: "Confidence-reactive stadium organ music using Tone.js"
      exports: ["MusicSystem"]
    - path: "src/game/systems/ReactiveCueSystem.ts"
      provides: "Threshold-triggered audio cues (organ stingers, cowbell, snare roll)"
      exports: ["ReactiveCueSystem"]
  key_links:
    - from: "src/game/systems/MusicSystem.ts"
      to: "src/game/config/audioConfig.ts"
      via: "imports music config (BPM, thresholds, envelope settings)"
      pattern: "AUDIO_CONFIG"
    - from: "src/game/systems/ReactiveCueSystem.ts"
      to: "src/game/config/audioConfig.ts"
      via: "imports cue config (thresholds, cooldown, BPM)"
      pattern: "AUDIO_CONFIG"
---

<objective>
Create the confidence-reactive stadium music system and reactive audio cue system.

Purpose: AUDI-03 (background music loop that shifts energy with confidence) and AUDI-04 (sound design matches emotional arc). These two systems work together: MusicSystem provides continuous background music that changes key/energy, while ReactiveCueSystem fires punctuation sounds (organ stingers, stomp-stomp-clap, cowbell, snare rolls) at confidence thresholds.

The aesthetic is STADIUM RALLY, not literal protest. Think baseball game organ riffs, rhythmic clap patterns, drum cadences. Patriotic/folk Americana feel.

Output: MusicSystem.ts, ReactiveCueSystem.ts
</objective>

<execution_context>
@/home/scott/.claude/get-shit-done/workflows/execute-plan.md
@/home/scott/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-audio-polish/10-RESEARCH.md
@.planning/phases/10-audio-polish/10-01-SUMMARY.md
@.planning/phases/10-audio-polish/10-02-SUMMARY.md
@src/game/config/audioConfig.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MusicSystem with confidence-reactive stadium organ music</name>
  <files>src/game/systems/MusicSystem.ts</files>
  <action>
    Create MusicSystem.ts — procedural stadium organ music using Tone.js that reacts to confidence level:

    1. Import from tone: PolySynth, FMSynth, Transport, Loop, Gain, getTransport
    2. Import AUDIO_CONFIG

    3. Define chord/phrase sets for 3 energy levels:
       - LOW (confidence < 30): Minor key, sparse. Example chords: Cm, Fm, Ab. Slow rhythm (half notes). Use FMSynth with muted harmonicity.
       - MID (confidence 30-80): Moderate. Example: C, F, G. Quarter notes. Standard organ tone.
       - HIGH (confidence > 80): Major key, triumphant. Example: C, F, G, Am resolving to C. Eighth notes with staccato. Bright organ with higher harmonicity.

    4. Stadium organ sound: Use Tone.PolySynth(Tone.FMSynth) with:
       - harmonicity: 3 (organ-like overtone structure)
       - modulationIndex: 10 (rich harmonics)
       - envelope from AUDIO_CONFIG.music (attack, decay, sustain, release)
       - Connect through Tone.Gain to output (not directly to destination — will connect to mixer)

    5. Music loop using Tone.Loop:
       - Pattern: on each beat, select chord from current energy level's phrase set
       - Phrase index advances through the chord progression, loops back
       - Rhythm varies: LOW = one chord every 2 beats, MID = every beat, HIGH = every half beat
       - Use Tone.getTransport() for tempo from AUDIO_CONFIG.music.bpm

    6. Methods:
       - constructor(): Create synth, gain, loop (don't start)
       - connectTo(destination: Tone.InputNode): wire gain to mixer's music channel
       - start(): Start transport and loop
       - stop(): Stop loop, let tail ring out (don't hard-cut)
       - updateConfidence(level: number): Store current confidence, energy level transitions smoothly — don't switch mid-phrase, wait for next phrase boundary
       - setVolume(dB: number)
       - destroy(): Dispose all Tone.js nodes

    7. Energy transition logic:
       - Track currentEnergy as 'low' | 'mid' | 'high'
       - On updateConfidence: compute target energy from thresholds
       - If target !== current: set pendingEnergyChange flag
       - At next phrase boundary (start of chord progression loop): apply the change
       - This prevents jarring mid-phrase key changes

    8. Static register/get helpers (Phaser registry pattern).

    IMPORTANT: The organ should sound like a baseball stadium organ, NOT a church organ. Keep it playful, rhythmic, slightly cheesy. Think "charge" riff, "take me out to the ball game" energy.
  </action>
  <verify>
    `npm run build` succeeds. `grep -r "MusicSystem" src/game/systems/MusicSystem.ts` shows the class with updateConfidence, start, stop methods.
  </verify>
  <done>MusicSystem produces stadium organ music that shifts energy (minor/sparse at low confidence, major/energetic at high confidence) using Tone.js procedural synthesis.</done>
</task>

<task type="auto">
  <name>Task 2: Create ReactiveCueSystem with stadium crowd cues</name>
  <files>src/game/systems/ReactiveCueSystem.ts</files>
  <action>
    Create ReactiveCueSystem.ts — fires punctuation audio cues at confidence thresholds:

    1. Import from tone: Synth, FMSynth, NoiseSynth, MembraneSynth, MetalSynth, Gain, getTransport, Loop
    2. Import AUDIO_CONFIG

    3. Cue types (all procedural via Tone.js, no audio files):
       a) ORGAN STINGER: Short FMSynth chord hit (3 notes, fast attack, quick decay). Triumphant major chord. Triggered on crossing HIGH threshold upward.
       b) STOMP-STOMP-CLAP: Three-hit rhythmic pattern using NoiseSynth. Two low thuds (stomp) + one bright crack (clap). Uses a scheduled Tone.Loop that plays 3 hits then stops. Triggered on crossing MID threshold upward.
       c) COWBELL: MetalSynth hit with high frequency, short decay. Played in a brief rhythmic burst (4 hits over 1 second). Triggered periodically at HIGH confidence.
       d) SNARE ROLL: NoiseSynth with highpass filter, 8 rapid hits with crescendo. Triggered on confidence crossing HIGH threshold.
       e) TENSION DRONE: Low FMSynth note with slow LFO modulation. Triggered on crossing LOW threshold downward. Stops when confidence rises above LOW.

    4. Class ReactiveCueSystem:
       - Private: synth instances for each cue type, output Gain node, lastCueTime (for cooldown), currentConfidence, previousConfidence
       - constructor(): Create synth instances (don't start), create output Gain
       - connectTo(destination: Tone.InputNode): wire gain to mixer's cues channel
       - update(confidence: number, deltaMs: number): Called each frame. Checks thresholds:
         - Crossing upward past highThreshold: trigger organ stinger + snare roll
         - Crossing upward past risingConfidenceCue: trigger stomp-stomp-clap
         - Dropping below lowConfidenceCue: start tension drone
         - Rising above lowConfidenceCue: stop tension drone
         - At HIGH confidence, periodically trigger cowbell burst (every cueIntervalMs)
       - Cooldown: minimum AUDIO_CONFIG.cues.cueIntervalMs between any two cues (except tension drone which is continuous)
       - Private methods: playOrganStinger(), playStompClap(), playCowbell(), playSnareRoll(), startTensionDrone(), stopTensionDrone()
       - destroy(): Dispose all synths and nodes

    5. Threshold crossing detection:
       - Store previousConfidence from last update call
       - "Crossing upward past X" = previousConfidence < X && confidence >= X
       - "Dropping below X" = previousConfidence >= X && confidence < X
       - This prevents cues from firing every frame while above threshold

    6. Static register/get helpers (Phaser registry pattern).

    IMPORTANT: These are STADIUM sounds, not protest chants. Organ stingers like after a home run. Stomp-stomp-clap like "We Will Rock You." Cowbell like a rally crowd. Keep it fun and energetic.
  </action>
  <verify>
    `npm run build` succeeds. `grep -r "ReactiveCueSystem" src/game/systems/ReactiveCueSystem.ts` shows the class with update, playOrganStinger, playStompClap methods.
  </verify>
  <done>ReactiveCueSystem fires stadium crowd audio cues at confidence thresholds with cooldown protection.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- MusicSystem has 3 energy levels driven by confidence thresholds
- MusicSystem uses phrase-boundary transitions (no mid-phrase key changes)
- ReactiveCueSystem detects threshold crossings (not just "above threshold")
- ReactiveCueSystem has cooldown between cues
- Both systems use AUDIO_CONFIG constants (no magic numbers)
- Both systems have connectTo() for mixer integration
- Both systems have destroy() for cleanup
</verification>

<success_criteria>
Stadium organ music plays continuously and shifts energy with confidence level. Reactive cues fire at threshold crossings — organ stingers on high confidence, stomp-clap on rising, cowbell at peaks, tension drone at lows. All procedural via Tone.js, no audio files.
</success_criteria>

<output>
After completion, create `.planning/phases/10-audio-polish/10-03-SUMMARY.md`
</output>
