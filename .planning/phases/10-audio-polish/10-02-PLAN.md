---
phase: 10-audio-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/systems/AmbientSystem.ts
  - src/game/config/audioConfig.ts
autonomous: true

must_haves:
  truths:
    - "AmbientSystem produces continuous brown noise filtered to sound like distant street traffic"
    - "Ambient sound has subtle variation (filter sweep) so it doesn't sound like static"
    - "AmbientSystem can start, stop, and adjust volume"
    - "Audio config centralizes all volume levels, frequency values, and timing constants"
  artifacts:
    - path: "src/game/systems/AmbientSystem.ts"
      provides: "Continuous ambient street noise using Tone.js Noise + filters"
      exports: ["AmbientSystem"]
    - path: "src/game/config/audioConfig.ts"
      provides: "Centralized audio configuration for all audio systems"
      exports: ["AUDIO_CONFIG"]
  key_links:
    - from: "src/game/systems/AmbientSystem.ts"
      to: "src/game/config/audioConfig.ts"
      via: "imports volume/frequency defaults"
      pattern: "AUDIO_CONFIG"
---

<objective>
Create the ambient street noise system and centralized audio configuration.

Purpose: AUDI-02 requires a background ambient layer that sets the outdoor protest scene. The AmbientSystem uses Tone.js Noise with filtering to create continuous, subtle street atmosphere. The audioConfig centralizes all magic numbers for easy tuning in Phase 12.

Output: AmbientSystem.ts, audioConfig.ts
</objective>

<execution_context>
@/home/scott/.claude/get-shit-done/workflows/execute-plan.md
@/home/scott/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-audio-polish/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audioConfig.ts with centralized audio constants</name>
  <files>src/game/config/audioConfig.ts</files>
  <action>
    Create audioConfig.ts with a single exported AUDIO_CONFIG object containing all audio tuning constants, organized by system:

    ```typescript
    export const AUDIO_CONFIG = {
      master: {
        defaultVolume: -6, // dB
      },
      layers: {
        ambient: { defaultVolume: -16 },  // dB — quiet background
        music: { defaultVolume: -14 },
        cues: { defaultVolume: -12 },
        sfx: { defaultVolume: -10 },
      },
      ambient: {
        noiseType: 'brown' as const,       // brown noise = low rumble, street-like
        filterFrequency: 250,               // Hz — lowpass cutoff for street feel
        filterQ: 1.5,
        autoFilterFrequency: 0.08,          // Hz — very slow filter sweep for variation
        autoFilterBaseFreq: 150,            // Hz
        autoFilterOctaves: 1.5,
        fadeInTime: 2,                      // seconds
        fadeOutTime: 1.5,                   // seconds
      },
      music: {
        bpm: 110,
        organAttack: 0.02,
        organDecay: 0.3,
        organSustain: 0.4,
        organRelease: 0.8,
        // Confidence thresholds for music energy shifts
        lowThreshold: 30,   // below this = minor/tense
        midThreshold: 60,   // below this = moderate
        highThreshold: 80,  // above this = triumphant
      },
      cues: {
        // Confidence thresholds for reactive audio cues
        lowConfidenceCue: 25,    // play tense cue
        risingConfidenceCue: 60, // play building cue
        highConfidenceCue: 80,   // play triumphant cue
        cueIntervalMs: 8000,     // minimum ms between reactive cues
        stompClapBpm: 110,       // matches music BPM
      },
      sfx: {
        honkVariants: 4,
        dopplerMinRate: 0.8,
        dopplerMaxRate: 1.3,
        dopplerDuration: 0.8, // seconds for pitch shift
      },
    };
    ```

    This config will be consumed by all audio systems. Values are tuning targets — Phase 12 debug overlay can adjust these.
  </action>
  <verify>
    `npm run build` succeeds. `grep "AUDIO_CONFIG" src/game/config/audioConfig.ts` shows the export.
  </verify>
  <done>audioConfig.ts exists with organized constants for all audio systems.</done>
</task>

<task type="auto">
  <name>Task 2: Create AmbientSystem with Tone.js street noise</name>
  <files>src/game/systems/AmbientSystem.ts</files>
  <action>
    Create AmbientSystem.ts that produces continuous ambient street noise:

    1. Import from tone: Noise, Filter, AutoFilter, Gain, getDestination, getContext
    2. Import AUDIO_CONFIG from audioConfig.ts

    3. Class AmbientSystem:
       - Private fields: noise (Tone.Noise), filter (Tone.Filter), autoFilter (Tone.AutoFilter), gain (Tone.Gain), isPlaying boolean
       - constructor(): Creates but does NOT start the audio chain:
         - Tone.Noise({ type: AUDIO_CONFIG.ambient.noiseType })
         - Tone.Filter({ frequency: AUDIO_CONFIG.ambient.filterFrequency, type: 'lowpass', Q: AUDIO_CONFIG.ambient.filterQ })
         - Tone.AutoFilter({ frequency: AUDIO_CONFIG.ambient.autoFilterFrequency, baseFrequency: AUDIO_CONFIG.ambient.autoFilterBaseFreq, octaves: AUDIO_CONFIG.ambient.autoFilterOctaves })
         - Tone.Gain({ gain: 0 }) — starts silent for fade-in
         - Chain: noise -> filter -> autoFilter -> gain
         - DO NOT connect gain to destination yet — that happens in connectTo()
       - connectTo(destination: Tone.InputNode): connects gain output to the provided destination (mixer's ambient channel)
       - start(): starts noise and autoFilter, ramps gain to 1 over fadeInTime
       - stop(): ramps gain to 0 over fadeOutTime, then stops noise
       - setVolume(dB: number): sets gain level
       - isActive(): returns isPlaying
       - destroy(): disposes all Tone.js nodes

    4. Static register/get helpers (Phaser registry pattern).

    The ambient sound should feel like distant traffic hum — low, warm, with slow breathing variation from the AutoFilter. Not white noise static.
  </action>
  <verify>
    `npm run build` succeeds. `grep -r "AmbientSystem" src/game/systems/AmbientSystem.ts` shows the class with start/stop/connectTo methods.
  </verify>
  <done>AmbientSystem produces brown noise filtered to sound like street traffic, with fade-in/out and volume control.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- audioConfig.ts exports AUDIO_CONFIG with ambient, music, cues, sfx sections
- AmbientSystem.ts creates Tone.js Noise -> Filter -> AutoFilter -> Gain chain
- AmbientSystem has start(), stop(), connectTo(), destroy() methods
- All values sourced from AUDIO_CONFIG (no magic numbers in AmbientSystem)
</verification>

<success_criteria>
Ambient system and config exist as standalone modules, ready to be wired into the mixer and IntersectionScene in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/10-audio-polish/10-02-SUMMARY.md`
</output>
