---
phase: 10-audio-polish
plan: 04
type: execute
wave: 3
depends_on: [01, 02, 03]
files_modified:
  - src/game/systems/AudioSystem.ts
  - src/game/scenes/IntersectionScene.ts
  - src/game/scenes/BootScene.ts
  - src/game/scenes/ScoreScene.ts
autonomous: false

must_haves:
  truths:
    - "Ambient street noise plays during gameplay and fades out on scene transition"
    - "Stadium organ music plays during gameplay, shifts energy with confidence"
    - "Reactive cues fire at confidence thresholds during gameplay"
    - "Honk sounds have variety (at least 3 distinct honk tones)"
    - "Honk sounds have doppler pitch shift effect"
    - "Coal roller rumble is enhanced with longer duration and sub-bass"
    - "Traffic light phase change has a mechanical clunk sound"
    - "Audio transitions between scenes are smooth (fade out on exit, fade in on enter)"
    - "All audio layers play together without any single layer dominating"
    - "Volume balance is comfortable across all layers"
  artifacts:
    - path: "src/game/scenes/IntersectionScene.ts"
      provides: "Full audio integration: all systems started, updated, and stopped with scene lifecycle"
    - path: "src/game/systems/AudioSystem.ts"
      provides: "Enhanced SFX: honk variety, doppler, improved coal roller, traffic light clunk"
  key_links:
    - from: "src/game/scenes/IntersectionScene.ts"
      to: "src/game/systems/AudioMixerSystem.ts"
      via: "Scene wires ambient, music, cues systems to mixer channels"
      pattern: "connectTo.*getLayerGain"
    - from: "src/game/scenes/IntersectionScene.ts"
      to: "src/game/systems/MusicSystem.ts"
      via: "update() passes confidence to musicSystem.updateConfidence()"
      pattern: "updateConfidence"
    - from: "src/game/scenes/IntersectionScene.ts"
      to: "src/game/systems/ReactiveCueSystem.ts"
      via: "update() passes confidence to cueSystem.update()"
      pattern: "cueSystem.update"
---

<objective>
Wire all audio systems into IntersectionScene, enhance SFX variety, add doppler honks and traffic light clunk, ensure smooth transitions and balanced volume.

Purpose: This is the integration plan — everything comes together. Ambient, music, and cues are wired into the game loop. SFX are enhanced with variety and doppler effects. Scene transitions fade audio smoothly. After this plan, all AUDI-01 through AUDI-06 requirements should be met. A human-verify checkpoint confirms the audio experience is pleasant.

Output: Fully integrated audio system with all layers playing in harmony.
</objective>

<execution_context>
@/home/scott/.claude/get-shit-done/workflows/execute-plan.md
@/home/scott/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-audio-polish/10-RESEARCH.md
@.planning/phases/10-audio-polish/10-01-SUMMARY.md
@.planning/phases/10-audio-polish/10-02-SUMMARY.md
@.planning/phases/10-audio-polish/10-03-SUMMARY.md
@src/game/systems/AudioSystem.ts
@src/game/systems/AudioMixerSystem.ts
@src/game/systems/AmbientSystem.ts
@src/game/systems/MusicSystem.ts
@src/game/systems/ReactiveCueSystem.ts
@src/game/config/audioConfig.ts
@src/game/scenes/IntersectionScene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance AudioSystem SFX — honk variety, doppler, coal roller, traffic light clunk</name>
  <files>src/game/systems/AudioSystem.ts</files>
  <action>
    Enhance the existing AudioSystem with improved SFX:

    1. HONK VARIETY: Replace single playHonk() with 3-4 distinct honk variations:
       - playHonkShort(): Quick toot. Square wave, 400Hz, 0.08s duration. Like a compact car.
       - playHonkLong(): Sustained horn. Square wave, 350Hz, hold 0.25s with slight frequency drift. Like a sedan.
       - playHonkDeep(): Low truck horn. Square wave, 200Hz + 220Hz detuned, 0.3s. Like a pickup truck.
       - playHonkCheerful(): Two-tone. Square wave, 500Hz then 600Hz, like a friendly double-tap.
       - In playReactionSound('honk'): randomly select from these 4 variants using Math.random().

    2. DOPPLER PITCH SHIFT: Add doppler effect to honk variants:
       - Use frequency.exponentialRampToValueAtTime to shift pitch during playback
       - Start slightly above base frequency (rate * 1.15), ramp down to slightly below (rate * 0.85) over the honk's duration
       - This simulates a car approaching and passing
       - Use AUDIO_CONFIG.sfx.dopplerMinRate and dopplerMaxRate for the pitch range

    3. COAL ROLLER ENHANCEMENT: Improve playDieselRumble():
       - Extend duration from 0.5s to 0.8s (it's a big truck, let it rumble)
       - Add a second lowpass filter sweep (frequency ramps from 300 down to 100) for engine roar character
       - Increase sub-bass oscillator prominence slightly
       - Add a short burst of higher-frequency noise at the start (the initial cloud puff)

    4. TRAFFIC LIGHT CLUNK: Add new playTrafficLightClunk():
       - Mechanical clunk sound: short metallic hit using high-frequency sine (1500Hz) with very fast decay (0.04s), plus a lower thud (200Hz sine, 0.06s)
       - Think of the physical relay click of old traffic signals

    5. Add a public method playTrafficLightChange() that calls playTrafficLightClunk(). This will be called from IntersectionScene when traffic light phase changes.

    6. IMPORTANT: Keep all existing public methods. This is additive enhancement, not replacement.
  </action>
  <verify>
    `npm run build` succeeds. `grep "playHonkShort\|playHonkLong\|playHonkDeep\|playHonkCheerful\|playTrafficLightChange\|playDieselRumble" src/game/systems/AudioSystem.ts` shows all new/enhanced methods.
  </verify>
  <done>AudioSystem has 4 honk variants with doppler pitch shift, enhanced diesel rumble, and new traffic light clunk sound.</done>
</task>

<task type="auto">
  <name>Task 2: Wire all audio systems into IntersectionScene game loop</name>
  <files>
    src/game/scenes/IntersectionScene.ts
    src/game/scenes/ScoreScene.ts
  </files>
  <action>
    Full integration of all audio systems into the game lifecycle:

    1. INTERSECTIONSCENE — IMPORTS: Add imports for AmbientSystem, MusicSystem, ReactiveCueSystem, AudioMixerSystem

    2. INTERSECTIONSCENE — PRIVATE FIELDS: Add ambientSystem, musicSystem, cueSystem, mixerSystem fields

    3. INTERSECTIONSCENE — CREATE():
       - After existing AudioSystem setup:
       - Create/retrieve AudioMixerSystem from registry (reuse pattern)
       - Create AmbientSystem, connect to mixer's ambient channel: ambientSystem.connectTo(mixerSystem.getLayerGain('ambient'))
       - Create MusicSystem, connect to mixer's music channel: musicSystem.connectTo(mixerSystem.getLayerGain('music'))
       - Create ReactiveCueSystem, connect to mixer's cues channel: cueSystem.connectTo(mixerSystem.getLayerGain('cues'))
       - Register all systems in Phaser registry (for cross-scene access and lifecycle)

    4. INTERSECTIONSCENE — FIRST-CLICK HANDLER (where audioSystem.init() is called):
       - After audioSystem.init(): also await mixerSystem.init() (starts Tone.js context)
       - Then: ambientSystem.start() (fades in street noise)
       - Then: musicSystem.start() (begins stadium organ)
       - IMPORTANT: These must be inside the user gesture handler for mobile compatibility

    5. INTERSECTIONSCENE — UPDATE():
       - After existing confidenceSystem.update(): get current confidence from gameState
       - Call musicSystem.updateConfidence(confidence) each frame
       - Call cueSystem.update(confidence, delta) each frame
       - NOTE: ambientSystem is autonomous (continuous noise, no frame updates needed)

    6. INTERSECTIONSCENE — TRAFFIC LIGHT CHANGE:
       - Find where traffic light phase changes occur (TrafficLightSystem emits phase change events or scene handles it directly)
       - On phase change: call audioSystem.playTrafficLightChange()

    7. INTERSECTIONSCENE — SCENE EXIT / GAME END:
       - In the game-end handler (where endState is processed):
       - Call ambientSystem.stop() (fade out)
       - Call musicSystem.stop() (fade out)
       - Use setTimeout or Phaser timer to delay scene transition by ~1.5s so audio fades complete before switching to ScoreScene
       - This prevents the abrupt silence that violates AUDI-05

    8. INTERSECTIONSCENE — MUTE TOGGLE:
       - Existing mute toggle calls audioSystem.toggleMute()
       - Also call mixerSystem.setMasterMute(muted) to mute all Tone.js layers

    9. SCORESCENE — Optional ambient:
       - In ScoreScene, if AudioMixerSystem exists in registry: start a quieter ambient (half volume) for scene continuity
       - On ScoreScene exit: stop ambient

    10. CLEANUP: In IntersectionScene shutdown(), call destroy() on ambientSystem, musicSystem, cueSystem if they exist. Don't destroy mixerSystem (it persists across scenes via registry).
  </action>
  <verify>
    `npm run build` succeeds. `grep -r "ambientSystem\|musicSystem\|cueSystem\|mixerSystem" src/game/scenes/IntersectionScene.ts` shows all four systems integrated. `grep "updateConfidence" src/game/scenes/IntersectionScene.ts` shows confidence being passed to music system.
  </verify>
  <done>All audio systems wired into IntersectionScene lifecycle. Ambient starts on first click, music reacts to confidence, cues fire at thresholds, audio fades out before scene transition, mute controls everything.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Audio experience verification</name>
  <files>src/game/scenes/IntersectionScene.ts</files>
  <action>
    Human verifies the complete audio experience. What was built:
    Complete audio system: ambient street noise, confidence-reactive stadium organ music, threshold-triggered cues (organ stingers, stomp-clap, cowbell), enhanced SFX (4 honk variants with doppler, improved coal roller, traffic light clunk), smooth transitions, volume balance.

    Steps to verify:
    1. Run `npm run dev` and open in browser
    2. Click to start game — you should hear:
       a. Ambient street noise fading in (subtle, low, continuous)
       b. Stadium organ music starting (moderate energy)
    3. Play the game and let confidence drop below 30:
       a. Music should shift to minor key, sparser
       b. Tension drone may start
    4. Get confidence above 80:
       a. Music should shift to major key, energetic
       b. Organ stingers and/or cowbell should fire
    5. Listen for honk variety — different cars should sound different
    6. Listen for doppler pitch shift on honks (pitch drops as "car passes")
    7. Wait for coal roller — should be a longer, deeper rumble
    8. Watch traffic light change — should hear mechanical clunk
    9. Let game end — audio should fade out smoothly (no pop/click)
    10. Check overall balance: no single layer dominates, everything is comfortable
    11. Test mute button — should silence ALL audio (SFX + music + ambient + cues)
    12. Test on mobile if possible — audio should start after first tap

    Resume signal: Type "approved" or describe any audio issues (too loud, wrong feel, missing sounds, etc.)
  </action>
  <verify>Human plays through a full game session and confirms all audio layers are present, balanced, and pleasant.</verify>
  <done>All audio layers verified as working: ambient, music, cues, SFX. Volume balance comfortable. Transitions smooth. Mute works.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no TypeScript errors
- Ambient plays during gameplay (AUDI-02)
- Music shifts with confidence (AUDI-03, AUDI-04)
- Reactive cues fire at thresholds (AUDI-04)
- Honk variety exists — 4 distinct sounds (AUDI-01)
- No single sound dominates (AUDI-01, AUDI-06)
- Audio fades on scene transition (AUDI-05)
- Mute toggle controls all audio layers
- Traffic light clunk audible on phase change
</verification>

<success_criteria>
All AUDI-01 through AUDI-06 requirements are met. Background ambient sets the scene. Music carries energy and shifts with confidence. Reactive cues punctuate moments. SFX are varied and balanced. Transitions are smooth. Volume balance is comfortable. Player can mute everything with one button.
</success_criteria>

<output>
After completion, create `.planning/phases/10-audio-polish/10-04-SUMMARY.md`
</output>
