---
phase: 10-audio-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/systems/AudioMixerSystem.ts
  - src/game/systems/AudioSystem.ts
  - src/game/scenes/IntersectionScene.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "AudioMixerSystem provides per-layer volume control for ambient, music, cues, and SFX layers"
    - "All existing AudioSystem sounds route through the mixer's SFX channel"
    - "Tone.js is installed and initializable alongside existing Web Audio API AudioContext"
    - "Both Tone.start() and AudioSystem.init() are gated on the same user gesture"
  artifacts:
    - path: "src/game/systems/AudioMixerSystem.ts"
      provides: "Master mixer with per-layer gain control, mute per layer, master mute"
      exports: ["AudioMixerSystem"]
    - path: "package.json"
      provides: "tone dependency"
      contains: "tone"
  key_links:
    - from: "src/game/systems/AudioMixerSystem.ts"
      to: "src/game/systems/AudioSystem.ts"
      via: "AudioSystem masterGain connects to mixer SFX channel"
      pattern: "sfxGain|masterGain"
    - from: "src/game/scenes/IntersectionScene.ts"
      to: "src/game/systems/AudioMixerSystem.ts"
      via: "Scene creates and registers mixer in Phaser registry"
      pattern: "AudioMixerSystem"
---

<objective>
Install Tone.js, create AudioMixerSystem with per-layer volume control, and wire existing AudioSystem through the mixer.

Purpose: Foundation for all audio work. The mixer provides independent volume control for 4 audio layers (ambient, music, reactive cues, SFX). Existing AudioSystem reaction sounds are preserved and routed through the SFX channel. Tone.js is installed and startup-gated alongside existing audio.

Output: AudioMixerSystem.ts, updated AudioSystem.ts, Tone.js in package.json
</objective>

<execution_context>
@/home/scott/.claude/get-shit-done/workflows/execute-plan.md
@/home/scott/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-audio-polish/10-RESEARCH.md
@src/game/systems/AudioSystem.ts
@src/game/scenes/IntersectionScene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Tone.js and create AudioMixerSystem</name>
  <files>
    package.json
    src/game/systems/AudioMixerSystem.ts
  </files>
  <action>
    1. Install Tone.js: `npm install tone`

    2. Create AudioMixerSystem.ts with:
       - 4 Tone.js Gain nodes as layer channels: ambient (default -16dB), music (default -14dB), cues (default -12dB), sfx (default -10dB)
       - A master Tone.js Gain node all layers feed into, connected to Tone.getDestination()
       - Methods: setLayerVolume(layer, dB), getLayerVolume(layer), muteLayer(layer), unmuteLayer(layer), setMasterMute(muted), getMasterMute()
       - An init() method that calls `await Tone.start()` (must be from user gesture)
       - A getSfxDestination() method that returns the sfx GainNode — this is what AudioSystem will connect to
       - An getLayerGain(layer) method returning the raw Tone.js Gain for other systems to connect to
       - Static register/get helpers following AudioSystem pattern (Phaser registry)
       - A destroy() method that disposes all Tone.js nodes

    3. Layer enum or type: 'ambient' | 'music' | 'cues' | 'sfx'

    4. Export AudioMixerSystem class.
  </action>
  <verify>
    `npm run build` succeeds. `grep -r "AudioMixerSystem" src/game/systems/AudioMixerSystem.ts` shows the class. `grep "tone" package.json` shows the dependency.
  </verify>
  <done>AudioMixerSystem exists with 4 layer channels and master gain. Tone.js is installed.</done>
</task>

<task type="auto">
  <name>Task 2: Wire AudioSystem through mixer and update IntersectionScene init</name>
  <files>
    src/game/systems/AudioSystem.ts
    src/game/scenes/IntersectionScene.ts
  </files>
  <action>
    1. Update AudioSystem.ts:
       - Add an optional `connectToMixer(mixerSfxNode: AudioNode)` method that disconnects masterGain from ctx.destination and reconnects it to the provided node. This bridges the raw Web Audio API AudioSystem into the Tone.js mixer graph.
       - IMPORTANT: Tone.js uses its own AudioContext. To bridge, use `Tone.getContext().rawContext` to get the underlying AudioContext and use `createMediaStreamDestination` or simply keep AudioSystem on its OWN AudioContext. The simplest approach: AudioSystem stays on its own AudioContext with its own output. The mixer controls volume for Tone.js-based layers only. The existing mute toggle in AudioSystem stays as-is.
       - REVISED APPROACH: Instead of bridging contexts, update AudioSystem to accept a volume level from the mixer. Add `setVolume(level: number)` method (0-1 range) that sets masterGain.gain.value. The AudioMixerSystem will coordinate volume levels across systems without needing to share AudioContext.
       - Keep all existing methods unchanged. This is additive only.

    2. Update IntersectionScene.ts:
       - Import AudioMixerSystem
       - In create(), after AudioSystem setup, create/get AudioMixerSystem from registry (same pattern as AudioSystem — reuse if exists, create if not)
       - Register AudioMixerSystem in Phaser registry
       - In the first-click handler (where audioSystem.init() is called), also call `await mixerSystem.init()` to start Tone.js context from user gesture
       - Update the mute toggle button to also call mixerSystem.setMasterMute() alongside audioSystem.toggleMute()
       - No other changes to IntersectionScene — ambient/music systems will be added in later plans

    3. Do NOT break any existing audio behavior. All current sounds must continue working exactly as before.
  </action>
  <verify>
    `npm run build` succeeds. `grep -r "AudioMixerSystem" src/game/scenes/IntersectionScene.ts` shows imports and usage. Existing reaction sounds still trigger (test by searching for playReactionSound calls — they should be unchanged).
  </verify>
  <done>AudioSystem has volume setter, IntersectionScene initializes both AudioSystem and AudioMixerSystem on user gesture, mute toggle controls both systems.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no TypeScript errors
- AudioMixerSystem.ts exports class with 4 layer channels
- Tone.js in package.json dependencies
- AudioSystem.ts has setVolume method, all existing methods unchanged
- IntersectionScene.ts creates and registers AudioMixerSystem
- First-click handler gates both AudioSystem.init() and AudioMixerSystem.init()
- Mute toggle controls both systems
</verification>

<success_criteria>
Audio foundation is in place: Tone.js installed, mixer system created with per-layer volume control, existing AudioSystem enhanced with volume setter, both audio contexts initialized from same user gesture, mute toggle controls everything.
</success_criteria>

<output>
After completion, create `.planning/phases/10-audio-polish/10-01-SUMMARY.md`
</output>
