---
phase: 08-sign-creator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/game/scenes/SignCraftScene.ts
  - src/game/config/signConfig.ts
  - src/lib/signEditor.ts
  - src/lib/signMaterials.ts
autonomous: true

must_haves:
  truths:
    - "Player sees a full-screen Fabric.js canvas sign editor before gameplay"
    - "Player can type text and it appears on the sign in real-time"
    - "Player can choose from at least 4 font styles and the sign text updates immediately"
    - "Player can pick text color from a palette of at least 6 marker/paint colors"
    - "Player can select from at least 4 material backgrounds with visually distinct textures"
    - "Player can drag and reposition text on the sign canvas"
  artifacts:
    - path: "src/lib/signEditor.ts"
      provides: "Fabric.js canvas sign editor class"
      min_lines: 150
    - path: "src/lib/signMaterials.ts"
      provides: "Material texture generation for sign backgrounds"
      min_lines: 80
    - path: "src/game/scenes/SignCraftScene.ts"
      provides: "Updated scene that mounts Fabric.js editor instead of old Phaser UI"
    - path: "src/game/config/signConfig.ts"
      provides: "Extended SignData interface with font, color, material, decorations fields"
  key_links:
    - from: "src/game/scenes/SignCraftScene.ts"
      to: "src/lib/signEditor.ts"
      via: "SignCraftScene creates/destroys SignEditor instance on create/shutdown"
      pattern: "new SignEditor|signEditor.destroy"
    - from: "src/lib/signEditor.ts"
      to: "fabric"
      via: "Fabric.js Canvas for interactive sign editing"
      pattern: "new fabric.Canvas|fabric.FabricText"
    - from: "src/lib/signMaterials.ts"
      to: "src/lib/signEditor.ts"
      via: "Material textures rendered as Fabric.js canvas background patterns"
      pattern: "generateMaterialTexture|setBackgroundImage"
---

<objective>
Build the Fabric.js sign editor with text editing, font selection, color picking, and material backgrounds.

Purpose: Replace the M1 material-picker + text-input with a real creative tool. The sign creator is half the experience — arts & crafts energy. Fabric.js handles all editing; Phaser just consumes the output image.

Output: A working Fabric.js canvas editor mounted by SignCraftScene with draggable text, font/color pickers, and material background selection.
</objective>

<execution_context>
@/home/scott/.claude/get-shit-done/workflows/execute-plan.md
@/home/scott/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/game/scenes/SignCraftScene.ts
@src/game/config/signConfig.ts
@src/game/entities/Player.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Fabric.js and create SignEditor class with text editing + fonts + colors</name>
  <files>
    package.json
    src/lib/signEditor.ts
    src/game/config/signConfig.ts
  </files>
  <action>
Install Fabric.js: `npm install fabric` (v6.x — the current major version).

Create `src/lib/signEditor.ts` — the core Fabric.js sign editor class:

```typescript
import { Canvas, FabricText } from 'fabric';
```

**SignEditor class** manages:
- A `fabric.Canvas` instance attached to a DOM canvas element
- Constructor accepts: container element, width, height, onChange callback
- `destroy()` method to clean up canvas and DOM elements

**Text editing:**
- Create a `FabricText` object with the sign message, centered on canvas
- Text is selectable and draggable (Fabric.js default interactive behavior)
- `setText(text: string)` method to update text content
- Text auto-sizes to fit sign dimensions (max fontSize, shrinks if too long)
- Support multi-line via `\n` in text

**Font selection (at least 4):**
- `setFont(fontFamily: string)` method
- Available fonts array: `['Permanent Marker', 'Impact', 'Courier New', 'Comic Sans MS']`
  - Permanent Marker = hand-drawn protest sign energy (load via Google Fonts link in HTML)
  - Impact = classic bold block letters
  - Courier New = stencil-like monospace
  - Comic Sans MS = casual/fun handwritten
- Preload Permanent Marker via a `<link>` tag added to document head at editor init (Google Fonts)
- Store selected font in editor state

**Color selection (at least 6 marker/paint colors):**
- `setTextColor(color: string)` method — sets `fill` on the FabricText object
- Color palette: `['#1a1a1a', '#dc2626', '#2563eb', '#ffffff', '#16a34a', '#7c3aed', '#ca8a04']`
  - Black (Sharpie), Red, Blue, White, Green, Purple, Gold
- Store selected color in editor state

**Update `src/game/config/signConfig.ts`:**
- Extend `SignData` interface to include: `fontFamily: string`, `textColor: string`, `decorations: string[]`, `signImageDataUrl: string | null`
- Keep backward compatibility: all new fields optional with defaults
- Add `SIGN_FONTS` and `SIGN_COLORS` arrays as exported constants
- Keep existing `SIGN_MATERIALS` but add a 4th material: `wood` (id: 'wood', label: 'Wood Plank', boardColor: 0x8B6914, strokeColor: 0x5C4033, heavy/very durable)
- Keep `scoreMessageQuality` and existing functions unchanged
  </action>
  <verify>
`npm run build` succeeds with no TypeScript errors. `import { SignEditor } from '../lib/signEditor'` resolves. SignData interface has new optional fields. SIGN_MATERIALS has 4 entries. SIGN_FONTS and SIGN_COLORS are exported arrays.
  </verify>
  <done>
SignEditor class exists with setText, setFont, setTextColor methods. signConfig.ts exports extended SignData, 4 materials, font list, color list. Fabric.js is in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create material texture system and wire SignEditor into SignCraftScene</name>
  <files>
    src/lib/signMaterials.ts
    src/lib/signEditor.ts
    src/game/scenes/SignCraftScene.ts
  </files>
  <action>
**Create `src/lib/signMaterials.ts`** — procedural material textures for sign backgrounds:

Each material gets a `generateMaterialTexture(materialId: string, width: number, height: number): HTMLCanvasElement` function that draws a procedural background onto an offscreen canvas:

- **Cardboard**: Tan base (#d4a574), draw horizontal grain lines (slightly darker, semi-transparent, varied spacing), slight noise texture. Torn/rough edges (jagged border).
- **Posterboard**: Clean white (#ffffff) with very subtle paper grain. Clean-cut edges (thin gray border).
- **Foam board**: Off-white (#f0f0f0) with slight foam-core texture (subtle dotted pattern). Thick, clean edges (darker border).
- **Wood**: Brown wood grain (#8B6914), draw horizontal wavy grain lines in varying browns, knot marks (small darker circles). Rough edges.

The Fabric.js canvas `setBackgroundImage` accepts a fabric.Image — convert the offscreen canvas to a data URL, then use `fabric.FabricImage.fromURL()` to load it as the canvas background.

Add `setMaterial(materialId: string)` method to SignEditor that:
1. Calls `generateMaterialTexture` for the selected material
2. Sets it as the Fabric.js canvas background
3. Re-renders the canvas

**Rewrite `src/game/scenes/SignCraftScene.ts`:**

The scene now acts as a thin orchestrator:
- `create()`:
  1. Create a DOM container `<div>` with a `<canvas>` element, positioned over the Phaser canvas
  2. Style the container: full-screen, z-index above Phaser canvas, dark background (#1a1a2e)
  3. Add UI controls as HTML elements (NOT Phaser objects) around/below the Fabric.js canvas:
     - **Material picker**: Row of 4 material thumbnail buttons (small canvas previews of each material texture). Tap to switch material background.
     - **Font picker**: Row of 4 font name buttons, each styled in its own font. Tap to switch font.
     - **Color picker**: Row of 7 color circle swatches. Tap to switch text color.
     - **Text input**: HTML input field at top for typing the sign message (on input → `signEditor.setText(value)`)
     - **"START PROTESTING" button**: Green button at bottom. On click → export sign, store data, transition to IntersectionScene.
  4. Instantiate `SignEditor` with the canvas element
  5. Set default material (cardboard), default font (Permanent Marker), default color (black)

- Layout: Mobile-first. Sign canvas takes center ~60% of viewport height. Controls stacked below. Use CSS flexbox, not Phaser layout.

- **Export flow** (on "START PROTESTING" click):
  1. `const dataUrl = signEditor.canvas.toDataURL({ format: 'png' })` — export Fabric.js canvas to PNG data URL
  2. Build `SignData` with all selections + `signImageDataUrl: dataUrl`
  3. `setSignData(this, signData)` — store in Phaser registry
  4. `signEditor.destroy()` — clean up DOM
  5. Remove the overlay DOM container
  6. `this.scene.start('IntersectionScene')` — transition to gameplay

- `shutdown()`: Clean up DOM container and SignEditor if still alive

**IMPORTANT architectural boundary:**
- Fabric.js lives in `src/lib/` (plain TypeScript, no Phaser dependency)
- SignCraftScene creates DOM overlay OVER the Phaser canvas for Fabric.js
- Phaser never touches Fabric.js; Fabric.js never touches Phaser
- The only bridge is the PNG data URL stored in SignData via Phaser registry
  </action>
  <verify>
`npm run build` succeeds. Run `npm run dev`, navigate to the game. The sign creator shows a Fabric.js canvas with a material background. Typing in the input updates text on the canvas. Tapping fonts changes the font. Tapping colors changes the text color. Tapping materials changes the background. Text is draggable on the canvas.
  </verify>
  <done>
SignCraftScene mounts a Fabric.js editor as a DOM overlay. Material textures render procedurally. Font, color, and material pickers work. Text is draggable. Clicking "START PROTESTING" exports PNG data URL, stores SignData, and transitions to IntersectionScene.
  </done>
</task>

</tasks>

<verification>
- Fabric.js canvas renders in the sign creator with a material background
- Text appears on the canvas and updates in real-time as the player types
- All 4 fonts are selectable and visually distinct on the sign
- All 7 colors are selectable and the text color changes immediately
- All 4 materials have visually distinct procedural textures
- Text is draggable/repositionable on the canvas
- "START PROTESTING" exports the canvas to a PNG data URL and transitions to the game
- The sign creator is full-screen and mobile-friendly (touch targets, responsive layout)
- No TypeScript errors, build succeeds
</verification>

<success_criteria>
Player can create a visually customized sign using Fabric.js with font, color, and material choices, and the sign exports as a PNG data URL stored in the Phaser registry.
</success_criteria>

<output>
After completion, create `.planning/phases/08-sign-creator/08-01-SUMMARY.md`
</output>
