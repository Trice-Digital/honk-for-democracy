---
phase: 08-sign-creator
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - src/game/scenes/SignCraftScene.ts
  - src/game/scenes/IntersectionScene.ts
  - src/game/scenes/ScoreScene.ts
  - src/game/entities/Player.ts
  - src/game/config/signConfig.ts
autonomous: false

must_haves:
  truths:
    - "The crafted sign with all customizations is visible on the player character during gameplay"
    - "The crafted sign is featured on the score screen with customizations intact"
    - "Material choice visually affects the sign in-game"
    - "Sign creator UI includes decoration picker alongside font/color/material pickers"
    - "The full sign creation flow works end-to-end: edit → export → gameplay → score screen"
  artifacts:
    - path: "src/game/entities/Player.ts"
      provides: "Player entity using exported PNG texture for sign display"
    - path: "src/game/scenes/IntersectionScene.ts"
      provides: "Scene that loads PNG data URL as Phaser texture for player sign"
    - path: "src/game/scenes/ScoreScene.ts"
      provides: "Score screen featuring the crafted sign PNG"
    - path: "src/game/scenes/SignCraftScene.ts"
      provides: "Complete sign creator with decoration picker UI"
  key_links:
    - from: "src/game/scenes/SignCraftScene.ts"
      to: "src/game/config/signConfig.ts"
      via: "setSignData stores PNG data URL + all customization choices in registry"
      pattern: "setSignData.*signImageDataUrl"
    - from: "src/game/scenes/IntersectionScene.ts"
      to: "src/game/config/signConfig.ts"
      via: "getSignData reads PNG data URL, loads as Phaser texture"
      pattern: "getSignData.*signImageDataUrl|textures.addBase64"
    - from: "src/game/entities/Player.ts"
      to: "src/game/scenes/IntersectionScene.ts"
      via: "Player receives sign texture key, displays as Phaser.GameObjects.Image"
      pattern: "setSignTexture|signTextureKey"
    - from: "src/game/scenes/ScoreScene.ts"
      to: "src/game/config/signConfig.ts"
      via: "Score screen reads signImageDataUrl to display crafted sign"
      pattern: "signImageDataUrl|signData"
---

<objective>
Wire the Fabric.js sign editor output into Phaser gameplay and score screens. Add decoration picker UI to SignCraftScene. Complete the end-to-end flow.

Purpose: The sign you create IS the sign your character holds. This plan bridges the Fabric.js editor output to Phaser consumption — the crafted PNG appears on the player in-game and is featured on the score screen. Also completes the sign creator UI by adding the decoration picker.

Output: Full sign creation flow working end-to-end: Fabric.js editing → PNG export → Phaser texture loading → player entity display → score screen feature.
</objective>

<execution_context>
@/home/scott/.claude/get-shit-done/workflows/execute-plan.md
@/home/scott/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-sign-creator/08-01-SUMMARY.md
@.planning/phases/08-sign-creator/08-02-SUMMARY.md
@src/game/scenes/SignCraftScene.ts
@src/game/scenes/IntersectionScene.ts
@src/game/scenes/ScoreScene.ts
@src/game/entities/Player.ts
@src/game/config/signConfig.ts
@src/lib/signEditor.ts
@src/lib/signDecorations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add decoration picker UI to SignCraftScene and complete editor controls</name>
  <files>
    src/game/scenes/SignCraftScene.ts
  </files>
  <action>
Update SignCraftScene's DOM overlay UI to include the decoration picker:

**Decoration picker section** (below color picker, above "START PROTESTING" button):
- Section label: "DECORATIONS" (styled like other section labels)
- 3 category tabs: "Stickers" | "Tape" | "Drawn" — tapping a tab shows that category's items
- Each category shows a horizontal scrollable row of decoration thumbnails
- Each thumbnail: 48x48px button showing the SVG decoration at small scale
- Tapping a decoration calls `signEditor.addDecoration(decoration)`
- Add a "Remove Selected" button (red, small) that calls `signEditor.removeSelected()` — only enabled when a decoration is selected on canvas

**Layout update:**
- The sign creator should scroll vertically on mobile if content exceeds viewport
- Sign canvas: ~280x200px on mobile, scales up on tablet/desktop (but not larger than 500x350)
- Controls stacked below canvas in sections: Material → Text Input → Font → Color → Decorations → Start Button
- Each section has a clear label and horizontally scrollable options

**Quality scoring update:**
- After the existing `scoreMessageQuality` call, add effort bonus from customizations:
  - Changed from default font: +0.05
  - Changed from default color (black): +0.05
  - Added any decorations: +0.05
  - Changed from default material (cardboard): +0.05
- Cap combined quality at 1.0
- Store in SignData.qualityScore

**Stored SignData on export:**
```typescript
const signData: SignData = {
  material: selectedMaterial,
  message: signMessage,
  qualityScore: combinedQuality,
  fontFamily: selectedFont,
  textColor: selectedColor,
  decorations: signEditor.getDecorations(),
  signImageDataUrl: signEditor.canvas.toDataURL({ format: 'png' }),
};
```
  </action>
  <verify>
`npm run build` succeeds. Run `npm run dev` — sign creator shows decoration picker with 3 category tabs. Tapping a sticker adds it to the canvas. Decorations are draggable. "Remove Selected" removes the selected decoration. All SignData fields are populated on export.
  </verify>
  <done>
SignCraftScene has complete UI: material picker, text input, font picker, color picker, decoration picker with 3 categories, and start button. All customizations stored in SignData with PNG data URL on export.
  </done>
</task>

<task type="auto">
  <name>Task 2: Load PNG into Phaser and update Player entity + ScoreScene</name>
  <files>
    src/game/scenes/IntersectionScene.ts
    src/game/entities/Player.ts
    src/game/scenes/ScoreScene.ts
    src/game/config/signConfig.ts
  </files>
  <action>
**Update IntersectionScene to load sign PNG as Phaser texture:**

In `create()`, after `getSignData(this)`:
1. Check if `signData.signImageDataUrl` exists
2. If yes: use `this.textures.addBase64('craftedSign', signData.signImageDataUrl)` to create a Phaser texture from the PNG data URL
3. The `addBase64` method is async — listen for `'addtexture'` event or use the callback to know when it's ready
4. Once texture is loaded, call `this.player.setSignTexture('craftedSign')` to update the player's sign display
5. If `signImageDataUrl` is null (backward compat with M1): fall back to existing rectangle-based sign rendering

**Update Player entity (`Player.ts`):**

Add a new method `setSignTexture(textureKey: string)`:
1. Remove the existing `signBoard` rectangle and `signText` text objects
2. Create a `Phaser.GameObjects.Image` using the texture key, positioned where the sign board was
3. Scale the image to fit the sign area on the player (~60x30px, maintaining aspect ratio)
4. Add the image to the player container

Keep existing `setSignMessage` and `setSignMaterial` methods for backward compatibility (they just won't be called when signImageDataUrl is present).

The player's sign should be a miniaturized version of their crafted sign — since the PNG data URL contains the full resolution canvas, Phaser just scales it down.

**Update ScoreScene to display crafted sign:**

In `create()`, replace the existing rectangle-based sign preview with:
1. Check `signData.signImageDataUrl`
2. If present: load as texture with `this.textures.addBase64('scoreSign', signData.signImageDataUrl)`
3. Once loaded, create a `Phaser.GameObjects.Image` at the sign display area
4. Scale to ~280x200px (prominent display on score screen)
5. Add a subtle border/shadow around it
6. If no signImageDataUrl: fall back to existing rectangle + text rendering (backward compat)

**Update signConfig.ts if needed:**
- Ensure all new SignData fields have defaults in `DEFAULT_SIGN_DATA`
- `signImageDataUrl: null` as default
- `fontFamily: 'Permanent Marker'`, `textColor: '#1a1a1a'`, `decorations: []` as defaults
  </action>
  <verify>
`npm run build` succeeds. Run `npm run dev` — create a sign with customizations, start the game. The player character holds a miniature version of the crafted sign (PNG texture, not rectangles). Complete a session — the score screen shows the full crafted sign prominently. Verify backward compatibility: if signImageDataUrl is null, old rectangle rendering still works.
  </verify>
  <done>
Crafted sign PNG appears on the player character during gameplay and is featured prominently on the score screen. Both use the Phaser texture loaded from the PNG data URL. Backward compatibility with M1 SignData maintained.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete sign creator flow end-to-end</name>
  <files>src/game/scenes/SignCraftScene.ts</files>
  <action>
Verify the complete sign creator pipeline: Fabric.js canvas editor with fonts, colors, materials, decorations → PNG export → Phaser texture on player in-game → sign featured on score screen.
  </action>
  <verify>
1. Run `npm run dev` and navigate to the game
2. Sign Creator: Verify the Fabric.js canvas loads with a cardboard background
3. Type a message — text appears on the sign canvas in real-time
4. Try all 4 fonts — each should look visually distinct
5. Try all 7 colors — text color changes immediately
6. Try all 4 materials — background texture changes (cardboard grain, white posterboard, foam dots, wood grain)
7. Drag the text to reposition it on the sign
8. Add a sticker from the decoration picker — it appears on the canvas and is draggable
9. Add tape and drawn accents — verify all 3 categories work
10. Click "START PROTESTING"
11. In-game: Verify the player character holds a miniature version of your crafted sign (not a colored rectangle)
12. Score screen: After the session ends, verify the score screen shows your crafted sign prominently with all customizations visible
13. Mobile: Test on mobile viewport (responsive layout, touch-friendly controls)
  </verify>
  <done>Complete sign creation flow verified: edit → export → gameplay → score screen. All customizations visible throughout.</done>
</task>

</tasks>

<verification>
- Complete sign creation flow: Fabric.js edit → PNG export → Phaser texture
- All 4 fonts selectable with real-time preview
- All 7 colors selectable with immediate update
- All 4 materials with distinct procedural textures
- At least 3 decoration types (stickers, tape, drawn accents)
- Decorations draggable, resizable, removable
- Text draggable on canvas
- Player character displays crafted sign PNG in-game
- Score screen features crafted sign PNG prominently
- Mobile-responsive layout with touch-friendly controls
- Backward compatibility with M1 SignData (no signImageDataUrl → falls back to rectangles)
- Quality scoring includes effort bonus from customizations
</verification>

<success_criteria>
The full sign creation pipeline works: player creates a customized sign in Fabric.js → it exports as PNG → Phaser loads it as a texture → the player character holds it in-game → it appears on the score screen. All 10 SIGN requirements (SIGN-10 through SIGN-19) are addressed.
</success_criteria>

<output>
After completion, create `.planning/phases/08-sign-creator/08-03-SUMMARY.md`
</output>
