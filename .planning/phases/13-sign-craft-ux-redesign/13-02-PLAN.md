---
phase: 13-sign-craft-ux-redesign
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/game/scenes/SignCraftScene.ts
autonomous: true

must_haves:
  truths:
    - "Sign preview is always visible (sticky mobile, side-by-side desktop)"
    - "Three tabs (Material, Message, Decorate) switch content areas"
    - "Material tab shows 13 swatches grouped by type with emoji labels"
    - "START PROTESTING and RANDOMIZE buttons are under the sign preview, not below the fold"
    - "Neobrutalist visual style matches mockup (kraft bg, black borders, yellow accents, drop shadows)"
  artifacts:
    - path: "src/game/scenes/SignCraftScene.ts"
      provides: "Complete responsive DOM layout with tabbed controls and sign preview"
      contains: "craft-layout"
  key_links:
    - from: "src/game/scenes/SignCraftScene.ts"
      to: "src/lib/signEditor.ts"
      via: "SignEditor instantiation in sign preview area"
      pattern: "new SignEditor"
    - from: "src/game/scenes/SignCraftScene.ts"
      to: "src/game/config/signConfig.ts"
      via: "imports SIGN_MATERIALS, SIGN_FONTS, SIGN_COLORS, getMaterialGroups"
      pattern: "getMaterialGroups"
    - from: "src/game/scenes/SignCraftScene.ts"
      to: "IntersectionScene"
      via: "scene.start on START PROTESTING click"
      pattern: "scene\\.start.*IntersectionScene"
---

<objective>
Rewrite SignCraftScene.ts with responsive two-column layout, tabbed controls (Material/Message/Decorate), sticky sign preview, and neobrutalist Paper Mario styling matching the mockup.

Purpose: This is the core UX redesign — transforming the single-column scroll into a proper two-panel creative tool. The layout structure and Material tab (the default tab) must work. Message and Decorate tabs get basic wiring here, with full functionality.
Output: Fully rewritten SignCraftScene.ts with all tabs, responsive layout, and existing export pipeline preserved.
</objective>

<execution_context>
@/home/scott/.claude/get-shit-done/workflows/execute-plan.md
@/home/scott/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-sign-craft-ux-redesign/CONTEXT.md
@.planning/phases/13-sign-craft-ux-redesign/13-01-SUMMARY.md
@mockups/sign-craft-redesign.html
@src/game/scenes/SignCraftScene.ts
@src/lib/signEditor.ts
@src/game/config/signConfig.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SignCraftScene layout + CSS + Material tab</name>
  <files>src/game/scenes/SignCraftScene.ts</files>
  <action>
Completely rewrite `mountFabricOverlay()` in SignCraftScene.ts. The new DOM structure must match the mockup at `mockups/sign-craft-redesign.html`. Inject a `<style>` tag into the overlay for all CSS (do NOT use inline styles for everything — use CSS classes matching the mockup's class names for maintainability).

**Injected CSS:** Copy the relevant CSS from the mockup into a `<style>` tag appended to the overlay container. Key classes: `.craft-layout`, `.sign-area`, `.sign-canvas`, `.controls-area`, `.tab-bar`, `.tab-btn`, `.panel`, `.panel-title`, `.tape-strip`, `.tape-label`, `.section-label`, `.swatch-row`, `.swatch`, `.text-input`, `.char-count`, `.color-row`, `.color-dot`, `.font-grid`, `.font-card`, `.pill-row`, `.pill`, `.sticker-grid`, `.sticker-item`, `.placed-list`, `.placed-tag`, `.randomize-btn`, `.cta-btn`, `.orient-hint`, `.tab-content`, `.paper-cut`, `.paper-cut-sm`. Include the responsive media queries for 768px breakpoint. Include the kraft background with SVG fractal noise texture from the mockup.

**DOM structure** (matching mockup):
```
#sign-editor-overlay (full screen, kraft bg + noise texture)
  style (injected CSS)
  .craft-layout (CSS Grid on desktop, single column on mobile)
    .sign-area (sticky)
      .sign-canvas.paper-cut (Fabric.js canvas container, rotate(-1.5deg))
      button-row (flex, gap)
        .randomize-btn (dice emoji + "RANDOMIZE!")
        .cta-btn ("START PROTESTING!")
      .orient-hint (two lines of orientation text)
    .controls-area (scrollable on desktop)
      .tab-bar (3 tab buttons: Material/Message/Decorate with step numbers)
      #tab-material.tab-content.active
        .panel > material swatches grouped by type
      #tab-message.tab-content
        .panel > textarea + char counter
        .panel > color dots
        .panel > font card grid
      #tab-decorate.tab-content
        .panel > sticker category pills + sticker grid + placed list
```

**Material Tab (Tab 1 — default active):**
- Use `getMaterialGroups()` to iterate material groups
- Each group: section label with emoji (e.g., "Cardboard"), swatch row
- Each swatch: 52x52px div with the material's `baseColor` as background, `2px solid #1a1a1a` border, `2px 2px 0` shadow, `4px` border-radius
- Selected state: `3px solid #fbbf24` outline with checkmark pseudo-element
- First material (cardboard) selected by default
- Click handler: calls `this.selectMaterial(material)` which updates SignEditor and swatch selection state

**Message Tab (Tab 2):**
- Textarea (2 rows, maxlength 60) with character counter showing "X/60"
- Color picker: 9 color dots (30px circles) with yellow outline on selected
- Font picker: 2x4 grid of font cards. Each card shows "HONK!" rendered in that font with the font name below. Selected card gets yellow background.
- Wire up: textarea input -> `signEditor.setText()`, color dot click -> `signEditor.setTextColor()`, font card click -> `signEditor.setFont()`

**Decorate Tab (Tab 3):**
- Category pills: Protest, Faces, Symbols, Animals, Things (from EMOJI_CATEGORIES)
- 6-column sticker grid showing emojis from selected category
- Click sticker -> `signEditor.addEmoji(emojiDef)`
- "On your sign" section: shows placed stickers with per-sticker remove buttons (X)
- Remove button calls `signEditor.canvas.remove(obj)` for specific sticker
- Track placed stickers in a `placedStickers` array of `{obj: FabricObject, emoji: string}` to enable per-sticker removal
- Update placed list whenever a sticker is added or removed

**Tab switching:**
- Click tab button -> toggle `.active` class on tab buttons and `.tab-content` divs
- All three tabs fully functional

**Sign preview area:**
- SignEditor canvas mounted inside `.sign-canvas` div
- Canvas size: `Math.min(520, containerWidth)` width, 4:3 aspect ratio
- Slight rotation via CSS `transform: rotate(-1.5deg)` on the canvas container
- Desktop: max-width 520px. Mobile: max-width 320px.

**Buttons under sign:**
- RANDOMIZE button: yellow bg, black border, dice emoji, `3px 3px 0` shadow, press effect
- START PROTESTING button: yellow bg, sign emoji, same style but slightly bigger text
- Both side by side in a flex row, centered
- START PROTESTING click -> `this.launchGame()` (preserve existing export logic exactly)

**Orientation hint:**
- Below buttons: two lines of text in Patrick Hand font, muted color
- Line 1: "Randomize for instant inspiration -- or customize below"
- Line 2: "Pick your material, write your message, add stickers. Then hit the streets!"

**State management:**
- Keep all existing state fields: selectedMaterial, selectedFont, selectedColor, signMessage
- Remove: selectedDecorationTab (no more stickers/tape toggle), removeButton ref
- Add: activeTab ('material'|'message'|'decorate'), selectedEmojiCategory (keep), placedStickers array

**Preserve exactly:**
- `launchGame()` method — export logic, quality scoring, scene transition
- `cleanupOverlay()` method — cleanup logic
- `shutdown()` method
- The Fabric.js SignEditor integration (instantiation, setText, setFont, setTextColor, setMaterialById, addEmoji, exportToPNG, getDecorations)

**Ghost text / empty state:**
- When no message typed: sign shows "HONK FOR DEMOCRACY" as ghost text at 30% opacity via the Fabric.js text object
- Set initial text to "HONK FOR DEMOCRACY" with opacity 0.3 on the FabricText
- When user types in textarea, clear ghost state (set opacity to 1, update text)
- If textarea cleared, restore ghost text

**Do NOT implement yet (Plan 03):** Randomize logic (button exists but click handler is placeholder showing "Coming soon" or empty for now). Actually, implement randomize in this plan too since it's all in the same file.

**Randomize feature:**
When RANDOMIZE button clicked:
1. Pick random material from SIGN_MATERIALS
2. Pick random font from SIGN_FONTS
3. Pick random text color — contrast-aware: for light materials (posterboard-*, foamboard-green, foamboard-purple), use dark colors (#1a1a1a, #DC143C, #1E90FF, #228B22, #8B008B). For dark materials (cardboard-*, wood-*, foamboard white), use light colors (#FFFFFF, #fbbf24, #FF8C00, #FF1493).
4. Pick random message from PRESET_MESSAGES
5. Clear existing stickers, place 0-3 random stickers at random positions/rotations
6. Update all UI: textarea value, selected material swatch, selected font card, selected color dot, placed stickers list
7. Update SignEditor: setMaterialById, setText, setFont, setTextColor, addEmoji for each sticker

Create a helper method `isLightMaterial(materialId: string): boolean` that returns true for posterboard-*, foamboard-green, foamboard-purple, posterboard (white). The contrast logic uses this to pick appropriate text colors.
  </action>
  <verify>
Run `npx tsc --noEmit` — no new type errors in SignCraftScene.ts.
Run `npm run dev` and visit localhost:4321 — SignCraftScene should render with two-column layout on desktop, all three tabs should switch, material swatches should update the sign preview.
  </verify>
  <done>
SignCraftScene renders with responsive two-column layout. All three tabs (Material/Message/Decorate) work. Material swatches, fonts, colors, and stickers update the Fabric.js sign preview. Randomize produces a complete sign. START PROTESTING exports and transitions to gameplay. Ghost text shows on empty state. Per-sticker removal works via placed list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify export pipeline and fix any integration issues</name>
  <files>src/game/scenes/SignCraftScene.ts</files>
  <action>
After the rewrite, verify the complete flow works end-to-end:

1. Check that `launchGame()` correctly exports the Fabric.js canvas to PNG data URL
2. Verify SignData is stored in Phaser registry with all fields (material, message, qualityScore, fontFamily, textColor, decorations, signImageDataUrl)
3. Verify scene transition to IntersectionScene works
4. Check that the overlay cleanup removes all DOM elements (style tag, container, etc.)
5. Test that calling `shutdown()` before `launchGame()` (e.g., if scene is stopped externally) doesn't throw

Fix any issues found. Common pitfalls:
- Style tag not removed on cleanup (add to cleanupOverlay)
- Canvas resize on window resize not handled (add resize listener if needed, remove on cleanup)
- Fabric.js canvas not disposed properly
- Font preloading race condition (fonts loaded via Layout.astro should be ready, but add document.fonts.ready check before rendering if needed)

Ensure the injected `<style>` tag has a unique ID (e.g., `sign-craft-styles`) so cleanup can find and remove it reliably.
  </action>
  <verify>
Run `npm run dev`, craft a sign with custom material/font/color/stickers, click START PROTESTING. Verify:
1. Sign appears on player character in IntersectionScene
2. No DOM elements from sign editor remain after transition
3. Console shows sign export log with correct data
  </verify>
  <done>Complete sign creation flow works: craft -> export -> gameplay -> score screen. No leaked DOM elements. All customizations preserved in exported PNG.</done>
</task>

</tasks>

<verification>
- SignCraftScene renders two-column layout on desktop (768px+), sticky sign on mobile
- All 3 tabs switch correctly, content updates
- 13 material swatches render in groups, clicking updates sign background
- 8 font cards show "HONK!" in correct font, clicking updates sign text
- 9 color dots with yellow selection outline, clicking updates sign text color
- Sticker emoji grid, per-sticker removal in placed list
- RANDOMIZE button produces complete contrast-correct sign
- START PROTESTING exports PNG and transitions to IntersectionScene
- Ghost text "HONK FOR DEMOCRACY" at 30% opacity on empty state
- No DOM leaks after scene transition
</verification>

<success_criteria>
The sign craft scene matches the mockup layout on both mobile and desktop. All controls work. Export pipeline preserved. Randomize functional. The complete user flow from sign creation to gameplay is unbroken.
</success_criteria>

<output>
After completion, create `.planning/phases/13-sign-craft-ux-redesign/13-02-SUMMARY.md`
</output>
