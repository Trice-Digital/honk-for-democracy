---
phase: 11-social-share
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/lib/ShareService.ts
  - src/game/scenes/ScoreScene.ts
  - src/game/scenes/ActivismScene.ts
autonomous: true

must_haves:
  truths:
    - "Score screen shows 'Share Your Protest' button that generates the share card"
    - "After card generation, player sees download and share buttons"
    - "Download button saves image to device on both iOS Safari and Android Chrome"
    - "Web Share API share button appears only on supported browsers/devices"
    - "Share flow transitions naturally to activism screen without blocking it"
    - "Player can skip sharing and go directly to activism screen"
  artifacts:
    - path: "src/lib/ShareService.ts"
      provides: "Download and Web Share API integration"
      exports: ["downloadImage", "canNativeShare", "nativeShare"]
    - path: "src/game/scenes/ScoreScene.ts"
      provides: "Share button UI in score screen"
    - path: "src/game/scenes/ActivismScene.ts"
      provides: "Unchanged or minimal update for share-to-activism flow"
  key_links:
    - from: "src/game/scenes/ScoreScene.ts"
      to: "src/lib/ShareCardGenerator.ts"
      via: "import { generateShareCard }"
      pattern: "generateShareCard"
    - from: "src/game/scenes/ScoreScene.ts"
      to: "src/lib/ShareService.ts"
      via: "import { downloadImage, canNativeShare, nativeShare }"
      pattern: "downloadImage|nativeShare"
    - from: "src/game/scenes/ScoreScene.ts"
      to: "src/game/scenes/ActivismScene.ts"
      via: "this.scene.start('ActivismScene')"
      pattern: "scene\\.start.*ActivismScene"
---

<objective>
Wire the share card into the game flow: add share UI to ScoreScene, implement download/share service, ensure natural transition to ActivismScene.

Purpose: This connects the share card generator to the player experience. The score screen gets a "Share Your Protest" button that generates the card, then offers download + native share options. The player can always skip to the activism screen.

Output: Working share flow in the game
</objective>

<execution_context>
@/home/scott/.claude/get-shit-done/workflows/execute-plan.md
@/home/scott/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-social-share/11-01-SUMMARY.md
@src/game/scenes/ScoreScene.ts
@src/game/scenes/ActivismScene.ts
@src/game/config/paletteConfig.ts
@src/game/utils/paperArt.ts
@src/game/config/scoreConfig.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ShareService — download and Web Share API</name>
  <files>src/lib/ShareService.ts</files>
  <action>
Create ShareService.ts in src/lib/ (pure DOM, no Phaser dependency).

**Export three functions:**

1. `canNativeShare(): boolean`
   - Returns true if `navigator.share` exists AND `navigator.canShare` exists
   - Also check that the browser can share files: test `navigator.canShare({ files: [new File([''], 'test.png', { type: 'image/png' })] })` wrapped in try/catch (some browsers have share but not file sharing)
   - This determines whether to show the "Share" button vs just "Download"

2. `async downloadImage(dataUrl: string, filename?: string): Promise<void>`
   - Default filename: `honk-for-democracy-{timestamp}.png`
   - Create a temporary `<a>` element with href=dataUrl, download=filename
   - Append to document.body, click(), remove
   - iOS Safari fallback: If the download attribute isn't supported (check with `'download' in document.createElement('a')`), open the image in a new tab/window via `window.open(dataUrl)` so the user can long-press to save

3. `async nativeShare(dataUrl: string, title?: string, text?: string): Promise<boolean>`
   - Default title: "My Protest Sign"
   - Default text: "I stood my ground at HonkForDemocracy.org"
   - Convert data URL to Blob: fetch(dataUrl).then(r => r.blob())
   - Create File from Blob: `new File([blob], 'honk-for-democracy.png', { type: 'image/png' })`
   - Call `navigator.share({ title, text, files: [file] })`
   - Return true on success, false on user cancel (AbortError), throw on other errors
   - Wrap in try/catch — if share fails entirely, fall back to downloadImage()

All functions are standalone, no class needed. Pure utility module.
  </action>
  <verify>
- TypeScript compiles: npx tsc --noEmit src/lib/ShareService.ts
- Exports verified: grep -E "export.*(downloadImage|canNativeShare|nativeShare)" src/lib/ShareService.ts
  </verify>
  <done>ShareService exports downloadImage (with iOS fallback), canNativeShare detection, and nativeShare (Web Share API with file sharing)</done>
</task>

<task type="auto">
  <name>Task 2: Score screen share UI + flow to activism</name>
  <files>src/game/scenes/ScoreScene.ts, src/game/scenes/ActivismScene.ts</files>
  <action>
Modify ScoreScene.ts to add share functionality. The existing button layout is: "CONTINUE" (primary, goes to ActivismScene) + "PLAY AGAIN" (secondary, goes to SignCraftScene). We're adding a share step.

**New flow:**
Score screen shows everything as before, but the CONTINUE button text changes to "SHARE YOUR PROTEST" (primary action). Below it: "SKIP TO ACTION" (secondary, text link style, goes to ActivismScene). "PLAY AGAIN" stays but moves below.

**When "SHARE YOUR PROTEST" is tapped:**

1. Show a brief loading state: button text changes to "CREATING..." with a subtle pulse animation
2. Call `generateShareCard()` with sign data and score data from the registry
3. On success, transition the button area to show the generated card preview + action buttons:
   - **Card preview:** Show a small version of the generated card (scaled down to ~200px wide) in the button area. Use the same Image loading pattern as the existing sign image display in ScoreScene.
   - **Download button:** Neobrutalist style (matching existing buttons). Text: "SAVE IMAGE". Taps `downloadImage()`.
   - **Share button** (only if canNativeShare() returns true): Neobrutalist style. Text: "SHARE". Taps `nativeShare()`.
   - **Continue button:** Below download/share. Text: "TAKE REAL ACTION" (goes to ActivismScene). This is now the primary CTA after sharing.
   - **Play Again:** Small text link below continue.

4. On failure (generateShareCard returns empty string): Show the regular Continue/Play Again buttons as fallback with a brief "Couldn't create share image" toast (just a text element that fades out after 2 seconds).

**Implementation details:**

- Import `generateShareCard` from `../../lib/ShareCardGenerator`
- Import `downloadImage`, `canNativeShare`, `nativeShare` from `../../lib/ShareService`
- Import `getScoreGrade` from config (already imported)
- The share card needs: signData.signImageDataUrl, finalState.score, grade.label, grade.color
- Store the generated dataUrl in a local variable so re-tapping download/share doesn't regenerate
- All new buttons use the existing neobrutalist pattern: hard offset shadow rectangle behind main button rectangle, press-into-shadow on click, hover state changes fill color
- Use PALETTE colors and FONTS.ui for consistency
- The button area calculation uses `Math.max(y, height - 140)` — adjust this to accommodate the new layout (may need height - 240 when showing share result with preview + 3 buttons)

**ActivismScene changes:** Minimal. No changes needed — the flow already works: ScoreScene calls `this.scene.start('ActivismScene')` and ActivismScene reads no special share data. Keep it as-is.

**Button layout (before share):**
```
[SHARE YOUR PROTEST]  (primary, actionBlue, 260x52)
SKIP TO ACTION →      (text link, no bg, craft brown)
[PLAY AGAIN]          (secondary, paperWhite, 260x44)
```

**Button layout (after share generated):**
```
[card preview, ~200px wide, centered]
[SAVE IMAGE]          (primary, stoplightGreen, 260x48)
[SHARE]               (primary, actionBlue, 260x48, only if canNativeShare)
[TAKE REAL ACTION →]  (secondary, paperWhite, 260x44)
PLAY AGAIN            (text link)
```
  </action>
  <verify>
- TypeScript compiles: npx tsc --noEmit src/game/scenes/ScoreScene.ts
- grep "generateShareCard" src/game/scenes/ScoreScene.ts confirms import
- grep "downloadImage" src/game/scenes/ScoreScene.ts confirms download integration
- grep "ActivismScene" src/game/scenes/ScoreScene.ts confirms flow preserved
  </verify>
  <done>Score screen has "Share Your Protest" button that generates card, shows preview with download/share/continue options. Share is skippable. Flow to ActivismScene preserved. Web Share API shows only when supported.</done>
</task>

</tasks>

<verification>
- Score screen renders with share button
- Tapping share generates a card and shows preview + action buttons
- Download button triggers image save
- Share button appears only on supported browsers
- "Skip to Action" and "Take Real Action" both navigate to ActivismScene
- "Play Again" navigates to SignCraftScene
- All buttons match neobrutalist Paper Mario aesthetic
- TypeScript compiles cleanly
</verification>

<success_criteria>
- Share card generation works from score screen with real sign + score data
- Download works on desktop and mobile (with iOS Safari fallback)
- Web Share API integrates when available, hidden when not
- Player can always skip sharing and proceed to activism screen
- UI matches Paper Mario protest aesthetic throughout
</success_criteria>

<output>
After completion, create `.planning/phases/11-social-share/11-02-SUMMARY.md`
</output>
